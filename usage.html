

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Basic Usage &mdash; OpusDistillery  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="QuickStart Tutorial" href="quickstart.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> OpusDistillery
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Get started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Basic Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuration-examples">Configuration Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running">Running</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#specific-target">Specific target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rerunning">Rerunning</a></li>
<li class="toctree-l3"><a class="reference internal" href="#canceling">Canceling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#on-lumi">On LUMI</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">QuickStart Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Setting up your experiment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="configs/configuration_files.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="configs/downloading_and_selecting_data.html">Dataset importers</a></li>
<li class="toctree-l1"><a class="reference internal" href="configs/examples.html">Examples of Configuration Files</a></li>
</ul>
<p class="caption"><span class="caption-text">The pipeline</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="pipeline/steps.html">Pipeline steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline/dir_structure.html">Directory structure</a></li>
</ul>
<p class="caption"><span class="caption-text">Other information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OpusDistillery</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Basic Usage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="basic-usage">
<h1>Basic Usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline">¶</a></h1>
<p>The pipeline is built using <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/">Snakemake</a>.</p>
<p>Snakemake is a workflow management system that implicitly constructs a Directed Acyclic Graph (DAG) of tasks based on the input and output files specified in each step. It determines which files are missing and executes the corresponding jobs, either locally or on a cluster, depending on the configuration. Snakemake can also parallelize steps that can be run concurrently.</p>
<p>The main Snakemake process (scheduler) should be launched interactively. It manages the job execution either on worker nodes in a cluster (cluster mode) or on a local machine (local mode).</p>
<div class="section" id="configuration-examples">
<h2>Configuration Examples<a class="headerlink" href="#configuration-examples" title="Permalink to this headline">¶</a></h2>
<p>The pipeline is executed using the provided <a class="reference external" href="https://github.com/Helsinki-NLP/OpusDistillery/blob/main/Makefile">Makefile</a>, which takes a configuration file as input. Configuration files are written in <a class="reference external" href="https://yaml.org/">YAML</a> format. You can find more details on configuration in the <a class="reference internal" href="configs/downloading_and_selecting_data.html"><span class="doc std std-doc">Setting up your experiment</span></a> section. Below is an example configuration file that trains a student model for Estonian, Finnish, and Hungarian into English:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">experiment</span><span class="p">:</span>
<span class="w">  </span><span class="nt">dirname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fiu-eng</span>
<span class="w">  </span><span class="nt">langpairs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">et-en</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fi-en</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hu-en</span>

<span class="w">  </span><span class="c1">#URL to the OPUS-MT model to use as the teacher</span>
<span class="w">  </span><span class="nt">opusmt-teacher</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://object.pouta.csc.fi/Tatoeba-MT-models/fiu-eng/opus4m-2020-08-12.zip&quot;</span>

<span class="w">  </span><span class="c1">#URL to the OPUS-MT model to use as the backward model</span>
<span class="w">  </span><span class="nt">opusmt-backward</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://object.pouta.csc.fi/Tatoeba-MT-models/eng-fiu/opus2m-2020-08-01.zip&quot;</span>
<span class="w">  </span><span class="nt">one2many-backward</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="w">  </span>
<span class="w">  </span><span class="nt">parallel-max-sentences</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000000</span>
<span class="w">  </span><span class="nt">split-length</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000000</span>

<span class="w">  </span><span class="nt">best-model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">perplexity</span>

<span class="nt">datasets</span><span class="p">:</span>
<span class="w">  </span><span class="nt">train</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tc_Tatoeba-Challenge-v2023-09-26</span>
<span class="w">  </span><span class="nt">devtest</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flores_dev</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flores_devtest</span>
</pre></div>
</div>
</div>
<div class="section" id="running">
<h2>Running<a class="headerlink" href="#running" title="Permalink to this headline">¶</a></h2>
<p>To check that everything is installed correctly, run a dry run first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">dry</span><span class="o">-</span><span class="n">run</span>
</pre></div>
</div>
<p>To execute the full pipeline, specify a specific profile and configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">PROFILE</span><span class="o">=</span><span class="n">slurm</span><span class="o">-</span><span class="n">puhti</span> <span class="n">CONFIG</span><span class="o">=</span><span class="n">configs</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<div class="section" id="specific-target">
<h3>Specific target<a class="headerlink" href="#specific-target" title="Permalink to this headline">¶</a></h3>
<p>By default, all Snakemake rules are executed. To run the pipeline up to a specific rule, use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">TARGET</span><span class="o">=&lt;</span><span class="n">non</span><span class="o">-</span><span class="n">wildcard</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="ow">or</span><span class="o">-</span><span class="n">path</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For example,  to collect the corpus first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">merge_corpus</span>
</pre></div>
</div>
<p>You can also specify the full file path, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">TARGET</span><span class="o">=/</span><span class="n">models</span><span class="o">/</span><span class="n">ru</span><span class="o">-</span><span class="n">en</span><span class="o">/</span><span class="n">bicleaner</span><span class="o">/</span><span class="n">teacher</span><span class="o">-</span><span class="n">base0</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">npz</span><span class="o">.</span><span class="n">best</span><span class="o">-</span><span class="n">ce</span><span class="o">-</span><span class="n">mean</span><span class="o">-</span><span class="n">words</span><span class="o">.</span><span class="n">npz</span>
</pre></div>
</div>
</div>
<div class="section" id="rerunning">
<h3>Rerunning<a class="headerlink" href="#rerunning" title="Permalink to this headline">¶</a></h3>
<p>If you need to rerun a specific step, delete the output files expected in the Snakemake rule.
If Snakemake reports a missing file and suggests running with the <code class="docutils literal notranslate"><span class="pre">--clean-metadata</span></code> flag, do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">clean</span><span class="o">-</span><span class="n">meta</span> <span class="n">TARGET</span><span class="o">=&lt;</span><span class="n">missing</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then as usual:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">PROFILE</span><span class="o">=&lt;</span><span class="n">profile</span><span class="o">&gt;</span> <span class="n">CONFIG</span><span class="o">=&lt;</span><span class="n">configuration</span><span class="o">-</span><span class="n">file</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="canceling">
<h3>Canceling<a class="headerlink" href="#canceling" title="Permalink to this headline">¶</a></h3>
<p>If you need to cancel a running pipeline on a cluster, remember to also cancel the associated SLURM jobs, as these will not be canceled automatically.
Additionally, delete any resulting files that you want to overwrite.</p>
</div>
<div class="section" id="on-lumi">
<h3>On LUMI<a class="headerlink" href="#on-lumi" title="Permalink to this headline">¶</a></h3>
<p>To run the pipeline on LUMI, start from the login node using your local copy of the root repository.</p>
<p>First, start a tmux session. You can read more about <a class="reference external" href="https://github.com/tmux/tmux/wiki">tmux</a> here.</p>
<p>Load the LUMI-specific modules:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>CrayEnv
module<span class="w"> </span>load<span class="w"> </span>PrgEnv-cray/8.3.3
module<span class="w"> </span>load<span class="w"> </span>craype-accel-amd-gfx90a
module<span class="w"> </span>load<span class="w"> </span>cray-python
module<span class="w"> </span>load<span class="w"> </span>rocm/5.3.3
<span class="nb">export</span><span class="w"> </span><span class="nv">SINGULARITYENV_LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$LD_LIBRARY_PATH</span>
</pre></div>
</div>
<p>Activate the Snakemake environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>../snakemake_env/bin/activate
</pre></div>
</div>
<p>You can now proceed as explained above.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="quickstart.html" class="btn btn-neutral float-right" title="QuickStart Tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>